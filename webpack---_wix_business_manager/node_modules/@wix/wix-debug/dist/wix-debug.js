"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = require('@wix/debug-no-namespace');

var resolve = require('./name-resolver');

var enableNamespace = require('./enable-namespace');

var assert = require('assert');

var jsonStringifySafe = require('json-stringify-safe'); // emit deprecation warning if used on server side


try {
  if (process && process.emitWarning && process.env && process.env.APP_CONF_DIR) {
    process.emitWarning('@wix/wix-debug is deprecated in server bootstrap projects. use @wix/wix-log instead', 'DeprecationWarning');
  }
} catch (err) {// ignore
}

var DebugLogger = /*#__PURE__*/function () {
  function DebugLogger(name) {
    var _this = this;

    var requestData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, DebugLogger);

    assert(name, 'Name must be provided');
    this._requestData = requestData;
    this._name = name;
    var logKeys = resolve(name);
    this._namespace = logKeys['error'];
    debug.enable(enableNamespace(process.env['DEBUG'], this._namespace));
    ['info', 'debug', 'error', 'trace', 'warn'].forEach(function (level) {
      var levelNamespace = logKeys[level];
      _this["_".concat(level)] = logWith(cachedLogger(levelNamespace), _this._requestData, levelNamespace, level);
    });
  }

  _createClass(DebugLogger, [{
    key: "withRequest",
    value: function withRequest(req) {
      return this.withAspects(req.aspects);
    }
  }, {
    key: "withAspects",
    value: function withAspects(aspects) {
      var requestId = get(aspects, 'raw.inbound.x-wix-request-id');
      return new DebugLogger(this._name, _objectSpread(_objectSpread({}, requestId ? {
        requestId: requestId
      } : {
        requestId: undefined
      }), this._requestData));
    }
  }, {
    key: "trace",
    value: function trace() {
      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      this._trace(args);
    }
  }, {
    key: "debug",
    value: function debug() {
      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      this._debug(args);
    }
  }, {
    key: "info",
    value: function info() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
        args[_key3] = arguments[_key3];
      }

      this._info(args);
    }
  }, {
    key: "error",
    value: function error() {
      for (var _len4 = arguments.length, args = new Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
        args[_key4] = arguments[_key4];
      }

      this._error(args);
    }
  }, {
    key: "warn",
    value: function warn() {
      for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {
        args[_key5] = arguments[_key5];
      }

      this._warn(args);
    }
  }]);

  return DebugLogger;
}();

function toKeyValueStringPairs(requestData) {
  return Object.keys(requestData).map(function (key) {
    return "[".concat(key, ": ").concat(requestData[key], "]");
  });
}

function isJsonEnabled() {
  return process.env['JSON_STDOUT'] === 'enabled';
}

var LOGGERS = new Map();

function cachedLogger(key) {
  var logger = LOGGERS.get(key);

  if (!logger) {
    logger = debug(key);
    LOGGERS.set(key, logger);
  }

  return logger;
}

function logWith(logger, requestData, namespace, level) {
  if (isJsonEnabled()) {
    return function (argsArray) {
      if (argsArray.length > 1) {
        argsArray = argsArray.map(function (arg) {
          return arg instanceof Error ? errorToObject(arg) : arg;
        });

        if (argsArray.every(function (item) {
          return _typeof(item) !== 'object';
        })) {
          argsArray = [argsArray.join(',')];
        } else {
          argsArray = [jsonStringifySafe(argsArray)];
        }
      }

      return logger.apply(logger, argsArray.map(function (el) {
        return debug.coerce(toJson(el, namespace, requestData, level));
      }));
    };
  }

  return function (argsArray) {
    return logger.apply(logger, toKeyValueStringPairs(requestData).concat(argsArray).map(function (el) {
      return debug.coerce(el);
    }));
  };
}

function toJson(param, namespace, requestData, level) {
  var _appName = process.env['APP_NAME'] || 'APP_NAME_NOT_SET';

  var _hostName = process.env['HOSTNAME'] || 'HOSTNAME_NOT_SET';

  var _dc = process.env['DC_NAME'] || 'DC_NOT_SET';

  var _shortAppName = process.env['SHORT_APP_NAME'] || 'SHORT_APP_NAME_NOT_SET';

  var additionalParams = {
    _appName: _appName,
    _hostName: _hostName,
    _dc: _dc,
    _shortAppName: _shortAppName,
    _namespace: namespace,
    _requestData: toKeyValueStringPairs(requestData),
    wnp_requestId: requestData.requestId,
    request_id: requestData.requestId,
    wnp_namespace: namespace,
    timestamp: new Date().toISOString(),
    level: level.toUpperCase()
  };

  if (param instanceof Object) {
    if (Array.isArray(param)) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
        text: jsonStringifySafe(param)
      }));
    }

    if (param instanceof Error) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), errorToObject(param)));
    }

    if (param._appName || param._hostName || param._dc || param._shortAppName || param._namespace || param._requestData || param.timestamp || Object.keys(param).find(function (k) {
      return k.startsWith('wnp_');
    })) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
        data: param,
        error: {
          message: 'Please don\'t use \'_appName\', \'_hostName\', \'_dc\', \'_shortAppName\', \'_namespace\', \'_requestData\', \'timestamp\' and params starting with \'wnp_\' in your JSON payload!'
        }
      }));
    }

    return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), param));
  }

  return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
    text: param
  }));
}

function errorToObject(err) {
  return {
    errorData: {
      message: err.message,
      name: err.name,
      stack: err.stack
    },
    message: err.message
  };
}

function get(obj, path) {
  var parts = path.split('.');
  var result = obj;

  while (result !== undefined && parts.length > 0) {
    result = result[parts.shift()];
  }

  return result;
}

module.exports = function (name) {
  return new DebugLogger(name);
};

module.exports.Logger = DebugLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93aXgtZGVidWcuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicmVzb2x2ZSIsImVuYWJsZU5hbWVzcGFjZSIsImFzc2VydCIsImpzb25TdHJpbmdpZnlTYWZlIiwicHJvY2VzcyIsImVtaXRXYXJuaW5nIiwiZW52IiwiQVBQX0NPTkZfRElSIiwiZXJyIiwiRGVidWdMb2dnZXIiLCJuYW1lIiwicmVxdWVzdERhdGEiLCJfcmVxdWVzdERhdGEiLCJfbmFtZSIsImxvZ0tleXMiLCJfbmFtZXNwYWNlIiwiZW5hYmxlIiwiZm9yRWFjaCIsImxldmVsIiwibGV2ZWxOYW1lc3BhY2UiLCJsb2dXaXRoIiwiY2FjaGVkTG9nZ2VyIiwicmVxIiwid2l0aEFzcGVjdHMiLCJhc3BlY3RzIiwicmVxdWVzdElkIiwiZ2V0IiwidW5kZWZpbmVkIiwiYXJncyIsIl90cmFjZSIsIl9kZWJ1ZyIsIl9pbmZvIiwiX2Vycm9yIiwiX3dhcm4iLCJ0b0tleVZhbHVlU3RyaW5nUGFpcnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwia2V5IiwiaXNKc29uRW5hYmxlZCIsIkxPR0dFUlMiLCJNYXAiLCJsb2dnZXIiLCJzZXQiLCJuYW1lc3BhY2UiLCJhcmdzQXJyYXkiLCJsZW5ndGgiLCJhcmciLCJFcnJvciIsImVycm9yVG9PYmplY3QiLCJldmVyeSIsIml0ZW0iLCJqb2luIiwiYXBwbHkiLCJlbCIsImNvZXJjZSIsInRvSnNvbiIsImNvbmNhdCIsInBhcmFtIiwiX2FwcE5hbWUiLCJfaG9zdE5hbWUiLCJfZGMiLCJfc2hvcnRBcHBOYW1lIiwiYWRkaXRpb25hbFBhcmFtcyIsInducF9yZXF1ZXN0SWQiLCJyZXF1ZXN0X2lkIiwid25wX25hbWVzcGFjZSIsInRpbWVzdGFtcCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInRvVXBwZXJDYXNlIiwiQXJyYXkiLCJpc0FycmF5IiwidGV4dCIsImZpbmQiLCJrIiwic3RhcnRzV2l0aCIsImRhdGEiLCJlcnJvciIsIm1lc3NhZ2UiLCJlcnJvckRhdGEiLCJzdGFjayIsIm9iaiIsInBhdGgiLCJwYXJ0cyIsInNwbGl0IiwicmVzdWx0Iiwic2hpZnQiLCJtb2R1bGUiLCJleHBvcnRzIiwiTG9nZ2VyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMseUJBQUQsQ0FBckI7O0FBQ0EsSUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsSUFBTUUsZUFBZSxHQUFHRixPQUFPLENBQUMsb0JBQUQsQ0FBL0I7O0FBQ0EsSUFBTUcsTUFBTSxHQUFHSCxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxJQUFNSSxpQkFBaUIsR0FBR0osT0FBTyxDQUFDLHFCQUFELENBQWpDLEMsQ0FFQTs7O0FBQ0EsSUFBSTtBQUNGLE1BQUlLLE9BQU8sSUFBSUEsT0FBTyxDQUFDQyxXQUFuQixJQUFrQ0QsT0FBTyxDQUFDRSxHQUExQyxJQUFpREYsT0FBTyxDQUFDRSxHQUFSLENBQVlDLFlBQWpFLEVBQStFO0FBQzdFSCxJQUFBQSxPQUFPLENBQUNDLFdBQVIsQ0FBb0IscUZBQXBCLEVBQTJHLG9CQUEzRztBQUNEO0FBQ0YsQ0FKRCxDQUlFLE9BQU9HLEdBQVAsRUFBWSxDQUNaO0FBQ0Q7O0lBRUtDLFc7QUFDSix1QkFBWUMsSUFBWixFQUFvQztBQUFBOztBQUFBLFFBQWxCQyxXQUFrQix1RUFBSixFQUFJOztBQUFBOztBQUNsQ1QsSUFBQUEsTUFBTSxDQUFDUSxJQUFELEVBQU8sdUJBQVAsQ0FBTjtBQUNBLFNBQUtFLFlBQUwsR0FBb0JELFdBQXBCO0FBQ0EsU0FBS0UsS0FBTCxHQUFhSCxJQUFiO0FBQ0EsUUFBTUksT0FBTyxHQUFHZCxPQUFPLENBQUNVLElBQUQsQ0FBdkI7QUFDQSxTQUFLSyxVQUFMLEdBQWtCRCxPQUFPLENBQUMsT0FBRCxDQUF6QjtBQUVBaEIsSUFBQUEsS0FBSyxDQUFDa0IsTUFBTixDQUFhZixlQUFlLENBQUNHLE9BQU8sQ0FBQ0UsR0FB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O0FBUUQ7O0FBRUQsU0FBU3JELEdBQVQsQ0FBYXdELEdBQWIsRUFBa0JDLElBQWxCLEVBQXdCO0FBQ3RCLE1BQU1DLEtBQUssR0FBR0QsSUFBSSxDQUFDRSxLQUFMLENBQVcsR0FBWCxDQUFkO0FBQ0EsTUFBSUMsTUFBTSxHQUFHSixHQUFiOztBQUNBLFNBQU9JLE1BQU0sS0FBSzNELFNBQVgsSUFBd0J5RCxLQUFLLENBQUN0QyxNQUFOLEdBQWUsQ0FBOUMsRUFBaUQ7QUFDL0N3QyxJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ0YsS0FBSyxDQUFDRyxLQUFOLEVBQUQsQ0FBZjtBQUNEOztBQUNELFNBQU9ELE1BQVA7QUFDRDs7QUFHREUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLFVBQUEvRSxJQUFJO0FBQUEsU0FBSSxJQUFJRCxXQUFKLENBQWdCQyxJQUFoQixDQUFKO0FBQUEsQ0FBckI7O0FBQ0E4RSxNQUFNLENBQUNDLE9BQVAsQ0FBZUMsTUFBZixHQUF3QmpGLFdBQXhCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZGVidWcgPSByZXF1aXJlKCdAd2l4L2RlYnVnLW5vLW5hbWVzcGFjZScpO1xuY29uc3QgcmVzb2x2ZSA9IHJlcXVpcmUoJy4vbmFtZS1yZXNvbHZlcicpO1xuY29uc3QgZW5hYmxlTmFtZXNwYWNlID0gcmVxdWlyZSgnLi9lbmFibGUtbmFtZXNwYWNlJyk7XG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKTtcbmNvbnN0IGpzb25TdHJpbmdpZnlTYWZlID0gcmVxdWlyZSgnanNvbi1zdHJpbmdpZnktc2FmZScpO1xuXG4vLyBlbWl0IGRlcHJlY2F0aW9uIHdhcm5pbmcgaWYgdXNlZCBvbiBzZXJ2ZXIgc2lkZVxudHJ5IHtcbiAgaWYgKHByb2Nlc3MgJiYgcHJvY2Vzcy5lbWl0V2FybmluZyAmJiBwcm9jZXNzLmVudiAmJiBwcm9jZXNzLmVudi5BUFBfQ09ORl9ESVIpIHtcbiAgICBwcm9jZXNzLmVtaXRXYXJuaW5nKCdAd2l4L3dpeC1kZWJ1ZyBpcyBkZXByZWNhdGVkIGluIHNlcnZlciBib290c3RyYXAgcHJvamVjdHMuIHVzZSBAd2l4L3dpeC1sb2cgaW5zdGVhZCcsICdEZXByZWNhdGlvbldhcm5pbmcnKTtcbiAgfVxufSBjYXRjaCAoZXJyKSB7XG4gIC8vIGlnbm9yZVxufVxuXG5jbGFzcyBEZWJ1Z0xvZ2dlciB7XG4gIGNvbnN0cnVjdG9yKG5hbWUsIHJlcXVlc3REYXRhID0ge30pIHtcbiAgICBhc3NlcnQobmFtZSwgJ05hbWUgbXVzdCBiZSBwcm92aWRlZCcpO1xuICAgIHRoaXMuX3JlcXVlc3REYXRhID0gcmVxdWVzdERhdGE7XG4gICAgdGhpcy5fbmFtZSA9IG5hbWU7XG4gICAgY29uc3QgbG9nS2V5cyA9IHJlc29sdmUobmFtZSk7XG4gICAgdGhpcy5fbmFtZXNwYWNlID0gbG9nS2V5c1snZXJyb3InXTtcblxuICAgIGRlYnVnLmVuYWJsZShlbmFibGVOYW1lc3BhY2UocHJvY2Vzcy5lbnZbJ0RFQlVHJ10sIHRoaXMuX25hbWVzcGFjZSkpO1xuXG4gICAgWydpbmZvJywgJ2RlYnVnJywgJ2Vycm9yJywgJ3RyYWNlJywgJ3dhcm4nXS5mb3JFYWNoKGxldmVsID0+IHtcbiAgICAgIGNvbnN0IGxldmVsTmFtZXNwYWNlID0gbG9nS2V5c1tsZXZlbF07XG4gICAgICB0aGlzW2BfJHtsZXZlbH1gXSA9IGxvZ1dpdGgoY2FjaGVkTG9nZ2VyKGxldmVsTmFtZXNwYWNlKSwgdGhpcy5fcmVxdWVzdERhdGEsIGxldmVsTmFtZXNwYWNlLCBsZXZlbCk7XG4gICAgfSk7XG4gIH1cblxuICB3aXRoUmVxdWVzdChyZXEpIHtcbiAgICByZXR1cm4gdGhpcy53aXRoQXNwZWN0cyhyZXEuYXNwZWN0cyk7XG4gIH1cblxuICB3aXRoQXNwZWN0cyhhc3BlY3RzKSB7XG4gICAgY29uc3QgcmVxdWVzdElkID0gZ2V0KGFzcGVjdHMsICdyYXcuaW5ib3VuZC54LXdpeC1yZXF1ZXN0LWlkJyk7XG4gICAgcmV0dXJuIG5ldyBEZWJ1Z0xvZ2dlcih0aGlzLl9uYW1lLCB7XG4gICAgICAuLi4ocmVxdWVzdElkID8ge3JlcXVlc3RJZH0gOiB7cmVxdWVzdElkOiB1bmRlZmluZWR9KSxcbiAgICAgIC4uLnRoaXMuX3JlcXVlc3REYXRhXG4gICAgfSk7XG4gIH1cblxuICB0cmFjZSguLi5hcmdzKSB7XG4gICAgdGhpcy5fdHJhY2UoYXJncyk7XG4gIH1cblxuICBkZWJ1ZyguLi5hcmdzKSB7XG4gICAgdGhpcy5fZGVidWcoYXJncyk7XG4gIH1cblxuICBpbmZvKC4uLmFyZ3MpIHtcbiAgICB0aGlzLl9pbmZvKGFyZ3MpO1xuICB9XG5cbiAgZXJyb3IoLi4uYXJncykge1xuICAgIHRoaXMuX2Vycm9yKGFyZ3MpO1xuICB9XG5cbiAgd2FybiguLi5hcmdzKSB7XG4gICAgdGhpcy5fd2FybihhcmdzKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0b0tleVZhbHVlU3RyaW5nUGFpcnMocmVxdWVzdERhdGEpIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHJlcXVlc3REYXRhKS5tYXAoa2V5ID0+IGBbJHtrZXl9OiAke3JlcXVlc3REYXRhW2tleV19XWApO1xufVxuXG5mdW5jdGlvbiBpc0pzb25FbmFibGVkKCkge1xuICByZXR1cm4gcHJvY2Vzcy5lbnZbJ0pTT05fU1RET1VUJ10gPT09ICdlbmFibGVkJztcbn1cblxuY29uc3QgTE9HR0VSUyA9IG5ldyBNYXAoKTtcbmZ1bmN0aW9uIGNhY2hlZExvZ2dlcihrZXkpIHtcbiAgbGV0IGxvZ2dlciA9IExPR0dFUlMuZ2V0KGtleSk7XG4gIGlmICghbG9nZ2VyKSB7XG4gICAgbG9nZ2VyID0gZGVidWcoa2V5KTtcbiAgICBMT0dHRVJTLnNldChrZXksIGxvZ2dlcik7XG4gIH1cbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuZnVuY3Rpb24gbG9nV2l0aChsb2dnZXIsIHJlcXVlc3REYXRhLCBuYW1lc3BhY2UsIGxldmVsKSB7XG4gIGlmIChpc0pzb25FbmFibGVkKCkpIHtcbiAgICByZXR1cm4gYXJnc0FycmF5ID0+IHtcbiAgICAgIGlmIChhcmdzQXJyYXkubGVuZ3RoID4gMSkge1xuICAgICAgICBhcmdzQXJyYXkgPSBhcmdzQXJyYXkubWFwKGFyZyA9PiBhcmcgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yVG9PYmplY3QoYXJnKSA6IGFyZyk7XG4gICAgICAgIGlmIChhcmdzQXJyYXkuZXZlcnkoaXRlbSA9PiB0eXBlb2YgaXRlbSAhPT0gJ29iamVjdCcpKSB7XG4gICAgICAgICAgYXJnc0FycmF5ID0gW2FyZ3NBcnJheS5qb2luKCcsJyldO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFyZ3NBcnJheSA9IFtqc29uU3RyaW5naWZ5U2FmZShhcmdzQXJyYXkpXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbG9nZ2VyLmFwcGx5KGxvZ2dlciwgYXJnc0FycmF5Lm1hcChlbCA9PiB7XG4gICAgICAgIHJldHVybiBkZWJ1Zy5jb2VyY2UodG9Kc29uKGVsLCBuYW1lc3BhY2UsIHJlcXVlc3REYXRhLCBsZXZlbCkpO1xuICAgICAgfSkpO1xuICAgIH07XG4gIH1cblxuICByZXR1cm4gYXJnc0FycmF5ID0+IGxvZ2dlci5hcHBseShsb2dnZXIsIHRvS2V5VmFsdWVTdHJpbmdQYWlycyhyZXF1ZXN0RGF0YSkuY29uY2F0KGFyZ3NBcnJheSkubWFwKGVsID0+IHtcbiAgICByZXR1cm4gZGVidWcuY29lcmNlKGVsKTtcbiAgfSkpO1xufVxuXG5mdW5jdGlvbiB0b0pzb24ocGFyYW0sIG5hbWVzcGFjZSwgcmVxdWVzdERhdGEsIGxldmVsKSB7XG4gIGNvbnN0IF9hcHBOYW1lID0gcHJvY2Vzcy5lbnZbJ0FQUF9OQU1FJ10gfHwgJ0FQUF9OQU1FX05PVF9TRVQnO1xuICBjb25zdCBfaG9zdE5hbWUgPSBwcm9jZXNzLmVudlsnSE9TVE5BTUUnXSB8fCAnSE9TVE5BTUVfTk9UX1NFVCc7XG4gIGNvbnN0IF9kYyA9IHByb2Nlc3MuZW52WydEQ19OQU1FJ10gfHwgJ0RDX05PVF9TRVQnO1xuICBjb25zdCBfc2hvcnRBcHBOYW1lID0gcHJvY2Vzcy5lbnZbJ1NIT1JUX0FQUF9OQU1FJ10gfHwgJ1NIT1JUX0FQUF9OQU1FX05PVF9TRVQnO1xuXG4gIGNvbnN0IGFkZGl0aW9uYWxQYXJhbXMgPSB7XG4gICAgX2FwcE5hbWUsXG4gICAgX2hvc3ROYW1lLFxuICAgIF9kYyxcbiAgICBfc2hvcnRBcHBOYW1lLFxuICAgIF9uYW1lc3BhY2U6IG5hbWVzcGFjZSxcbiAgICBfcmVxdWVzdERhdGE6IHRvS2V5VmFsdWVTdHJpbmdQYWlycyhyZXF1ZXN0RGF0YSksXG4gICAgd25wX3JlcXVlc3RJZDogcmVxdWVzdERhdGEucmVxdWVzdElkLFxuICAgIHJlcXVlc3RfaWQ6IHJlcXVlc3REYXRhLnJlcXVlc3RJZCxcbiAgICB3bnBfbmFtZXNwYWNlOiBuYW1lc3BhY2UsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgbGV2ZWw6IGxldmVsLnRvVXBwZXJDYXNlKClcbiAgfTtcblxuICBpZiAocGFyYW0gaW5zdGFuY2VvZiBPYmplY3QpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShwYXJhbSkpIHtcbiAgICAgIHJldHVybiBqc29uU3RyaW5naWZ5U2FmZSh7XG4gICAgICAgIC4uLmFkZGl0aW9uYWxQYXJhbXMsXG4gICAgICAgIHRleHQ6IGpzb25TdHJpbmdpZnlTYWZlKHBhcmFtKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmFtIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgIHJldHVybiBqc29uU3RyaW5naWZ5U2FmZSh7XG4gICAgICAgIC4uLmFkZGl0aW9uYWxQYXJhbXMsXG4gICAgICAgIC4uLmVycm9yVG9PYmplY3QocGFyYW0pXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAocGFyYW0uX2FwcE5hbWUgfHwgcGFyYW0uX2hvc3ROYW1lIHx8IHBhcmFtLl9kYyB8fCBwYXJhbS5fc2hvcnRBcHBOYW1lIHx8IHBhcmFtLl9uYW1lc3BhY2UgfHwgcGFyYW0uX3JlcXVlc3REYXRhIHx8IHBhcmFtLnRpbWVzdGFtcCB8fCBPYmplY3Qua2V5cyhwYXJhbSkuZmluZChrID0+IGsuc3RhcnRzV2l0aCgnd25wXycpKSkge1xuICAgICAgcmV0dXJuIGpzb25TdHJpbmdpZnlTYWZlKHtcbiAgICAgICAgLi4uYWRkaXRpb25hbFBhcmFtcyxcbiAgICAgICAgZGF0YTogcGFyYW0sXG4gICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgbWVzc2FnZTogJ1BsZWFzZSBkb25cXCd0IHVzZSBcXCdfYXBwTmFtZVxcJywgXFwnX2hvc3ROYW1lXFwnLCBcXCdfZGNcXCcsIFxcJ19zaG9ydEFwcE5hbWVcXCcsIFxcJ19uYW1lc3BhY2VcXCcsIFxcJ19yZXF1ZXN0RGF0YVxcJywgXFwndGltZXN0YW1wXFwnIGFuZCBwYXJhbXMgc3RhcnRpbmcgd2l0aCBcXCd3bnBfXFwnIGluIHlvdXIgSlNPTiBwYXlsb2FkISdcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGpzb25TdHJpbmdpZnlTYWZlKHtcbiAgICAgIC4uLmFkZGl0aW9uYWxQYXJhbXMsXG4gICAgICAuLi5wYXJhbVxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGpzb25TdHJpbmdpZnlTYWZlKHtcbiAgICAuLi5hZGRpdGlvbmFsUGFyYW1zLFxuICAgIHRleHQ6IHBhcmFtXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBlcnJvclRvT2JqZWN0KGVycikge1xuICByZXR1cm4ge1xuICAgIGVycm9yRGF0YToge1xuICAgICAgbWVzc2FnZTogZXJyLm1lc3NhZ2UsXG4gICAgICBuYW1lOiBlcnIubmFtZSxcbiAgICAgIHN0YWNrOiBlcnIuc3RhY2tcbiAgICB9LFxuICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlXG4gIH07XG59XG5cbmZ1bmN0aW9uIGdldChvYmosIHBhdGgpIHtcbiAgY29uc3QgcGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7XG4gIGxldCByZXN1bHQgPSBvYmo7XG4gIHdoaWxlIChyZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBwYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgcmVzdWx0ID0gcmVzdWx0W3BhcnRzLnNoaWZ0KCldO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxubW9kdWxlLmV4cG9ydHMgPSBuYW1lID0+IG5ldyBEZWJ1Z0xvZ2dlcihuYW1lKTtcbm1vZHVsZS5leHBvcnRzLkxvZ2dlciA9IERlYnVnTG9nZ2VyO1xuIl19